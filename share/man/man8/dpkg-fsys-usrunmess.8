.\" Automatically generated by Pod::Man 4.14 (Pod::Simple 3.42)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is >0, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{\
.    if \nF \{\
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{\
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\" ========================================================================
.\"
.IX Title "dpkg-fsys-usrunmess 8"
.TH dpkg-fsys-usrunmess 8 "2024-03-10" "1.22.6" "dpkg suite"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "NAME"
dpkg\-fsys\-usrunmess \- undoes the merged\-/usr\-via\-aliased\-dirs mess
.SH "SYNOPSIS"
.IX Header "SYNOPSIS"
\&\fBdpkg-fsys-usrunmess\fR [\fBoption\fR...]
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
\&\fBdpkg-fsys-usrunmess\fR is a tool to fix up filesystems that have been
installed anew with recent installers with unfortunate defaults or
migrated to the broken merged /usr via aliased directories layout,
which is \fBnot\fR supported by dpkg.
See the dpkg \s-1FAQ.\s0
.PP
\&\fBNote\fR: In Debian its tech-ctte has decreed that on the release after
bookworm the non-usrmerged layout is not going to be supported, and thus
some of its maintainers might not fix issues or intentionally remove
non-usrmerged support, so you will need decide and pick your poison.
.PP
The program will perform the following overall actions:
.IP "\(bu" 4
Check whether the system needs to be switched, otherwise do nothing,
.IP "\(bu" 4
Check for dpkg database consistency and otherwise abort.
.IP "\(bu" 4
Generate and install a regression prevention package, if requested on the
command-line or otherwise on the prompt.
.IP "\(bu" 4
Get the list of files and alternatives that need to be restored.
.IP "\(bu" 4
Look for untracked kernel modules files that need to be moved too.
.IP "\(bu" 4
Create a shadow hierarchy under \fI/.usrunmess\fR, by creating the directories
symlinks or hardlinking or copying the files as needed.
.IP "\(bu" 4
Prompt for confirmation before proceeding, if requested on the command-line.
.IP "\(bu" 4
Lock the dpkg database.
.IP "\(bu" 4
Mark all packages as half-configured to force running maintainer scripts
that might need to recreate files.
.IP "\(bu" 4
Replace the aliased directories with the shadow ones, by creating a backup
of the old symlinked directories and renaming the shadow ones over.
.IP "\(bu" 4
Relabel \s-1MAC\s0 information for directories and symlinks if necessary.
.IP "\(bu" 4
Remove backup symlinks.
.IP "\(bu" 4
Remove old moved objects, but defer directory removal.
.IP "\(bu" 4
Remove old deferred directories that are not referenced by dpkg-query.
.IP "\(bu" 4
Remove shadow root directory.
.IP "\(bu" 4
Register a \fBpolicy\-rc.d\fR to disallow service actions, which means that
services might need to be restarted afterwards, ideally via a reboot.
.IP "\(bu" 4
Reconfigure all packages.
.IP "\(bu" 4
Unregister the \fBpolicy\-rc.d\fR and restore the alternatives state.
.PP
\&\fBNote\fR: When running the program from some shells such as \fBbash\fR\|(1) or
\&\fBzsh\fR\|(1), after executing it, you might need to request the shell to
forget all remembered executable locations with for example \f(CW\*(C`hash \-r\*(C'\fR.
.PP
\&\fBNote\fR: Some directories might linger after the migration in case they
contain untracked files.
A list is printed once the script has finished
for further investigation.
.PP
\&\fBWarning\fR: Note that this operation has the potential to render the system
unusable or broken in case of a sudden crash or reboot, unexpected state of
the system, or possible bugs in the script.
Be prepared with recovery media
and consider doing backups beforehand.
.PP
This program was introduced in dpkg 1.20.6.
.SH "OPTIONS"
.IX Header "OPTIONS"
.IP "\fB\-p\fR, \fB\-\-prompt\fR" 4
.IX Item "-p, --prompt"
Prompt at the time of no return, so that the debug output or the shadow
hierarchy can be evaluated before proceeding.
.IP "\fB\-\-prevention\fR" 4
.IX Item "--prevention"
.PD 0
.IP "\fB\-\-no\-prevention\fR" 4
.IX Item "--no-prevention"
.PD
Enables or disables generating and installing a regression prevention package
into the system.
If no option has been specified, the action to take will be prompted.
.Sp
The generated package contains the \fBProtected\fR field set to \fByes\fR to
protect against accidental removal of the package.
.IP "\fB\-n\fR, \fB\-\-no\-act\fR" 4
.IX Item "-n, --no-act"
.PD 0
.IP "\fB\-\-dry\-run\fR" 4
.IX Item "--dry-run"
.PD
This option enables the dry-run mode, where no destructive action takes place,
only the preparatory part.
.IP "\fB\-?\fR, \fB\-\-help\fR" 4
.IX Item "-?, --help"
Show the usage message and exit.
.IP "\fB\-\-version\fR" 4
.IX Item "--version"
Show the version and exit.
.SH "ENVIRONMENT"
.IX Header "ENVIRONMENT"
.IP "\fB\s-1DPKG_USRUNMESS_NOACT\s0\fR" 4
.IX Item "DPKG_USRUNMESS_NOACT"
This setting defines whether to enable dry-run mode.
.SH "SEE ALSO"
.IX Header "SEE ALSO"
<https://wiki.debian.org/Teams/Dpkg/FAQ#broken\-usrmerge>.
